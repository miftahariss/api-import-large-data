# Laravel Product Import API with Queue

A REST API to import large-scale product data asynchronously using Redis Queue.

## Requirements

- PHP >= 8.1
- Composer
- MySQL
- Redis
- Laravel 10.x

## Installation

1. Clone repository dan install dependencies:
```bash
composer install
```

2. Copy environment file:
```bash
cp .env.example .env
```

3. Configure database di `.env`:
```env
DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=commerce
DB_USERNAME=root
DB_PASSWORD=

QUEUE_CONNECTION=redis
REDIS_CLIENT=predis
REDIS_HOST=127.0.0.1
REDIS_PASSWORD=null
REDIS_PORT=6379
```

4. Generate application key:
```bash
php artisan key:generate
```

5. Run migrations:
```bash
php artisan migrate
```

6. Run the seeders. If you need a sample CSV file with a large dataset, you can use the file generated by the seeder located in /storage/app/imports:
```bash
php artisan db:seed
```

7. Start queue worker:
```bash
php artisan queue:work redis --queue=product-import --tries=3 --timeout=300
```

8. Start application:
```bash
php artisan serve
```

## Authentication

This API uses JWT Authentication. After running the seeder, use the following credentials:

**Email:** admin@example.com  
**Password:** password

### Login Endpoint

**POST** `/api/auth/login`

Request:
```json
{
    "email": "admin@example.com",
    "password": "password"
}
```

Response:
```json
{
    "access_token": "your-jwt-token",
    "token_type": "bearer",
    "expires_in": 3600
}
```

Use the token for all subsequent requests:
```
Authorization: Bearer {your-jwt-token}
```

## API Endpoints

### 1. Upload CSV File

**POST** `/api/import/products`

Headers:
```
Authorization: Bearer {token}
Content-Type: multipart/form-data
```

Body (form-data):
- `file`: CSV file

CSV Format:
```csv
name,sku,price,stock
Product A,SKU001,10000.00,100
Product B,SKU002,20000.00,50
```

Response:
```json
{
    "job_id": 1,
    "status": "pending",
    "message": "File uploaded successfully and queued for processing"
}
```

### 2. Check Import Status

**GET** `/api/import/status/{job_id}`

Headers:
```
Authorization: Bearer {token}
```

Response:
```json
{
    "job_id": 1,
    "filename": "products.csv",
    "status": "completed",
    "total": 1000,
    "success": 995,
    "failed": 5,
    "created_at": "2025-03-27 04:50:30",
    "updated_at": "2025-03-27 05:00:52"
}
```

Status values:
- `pending`: Job has not started
- `in_progress`: Job is being processed
- `completed`: Job completed successfully
- `failed`: Job failed

### 3. List All Jobs

**GET** `/api/import/jobs`

Headers:
```
Authorization: Bearer {token}
```

Response:
```json
{
    "data": [
        {
            "job_id": 1,
            "filename": "products.csv",
            "status": "completed",
            "total": 1000,
            "success": 995,
            "failed": 5,
            "created_at": "2025-03-27 04:50:30",
            "updated_at": "2025-03-27 05:00:52"
        }
    ]
}
```

## Sample CSV File

Create a file named `products.csv` or anything else:
```csv
name,sku,price,stock
Laptop Dell XPS,DELL-XPS-001,15000000.00,25
iPhone 15 Pro,APPLE-IP15-001,18000000.00,50
Samsung Galaxy S24,SAMS-S24-001,12000000.00,30
MacBook Pro M3,APPLE-MBP-001,25000000.00,15
Sony WH-1000XM5,SONY-WH-001,4500000.00,100
```

## Error Handling

- Invalid CSV format → 422 Unprocessable Entity
- Authentication failure → 401 Unauthorized
- Job not found → 404 Not Found
- Row-level errors during import are logged and do not stop the entire process

## Testing with Postman

Import the provided Postman collection `Product_Import_API.postman_collection.json`.

Collection includes:
1. Login
2. Upload CSV
3. Check Status
4. List Jobs

## Logging

Logs are stored in:
- `storage/logs/laravel.log` - Application logs
- Queue worker logs - Worker activity

## Database Schema

### products table
- id (INT, PRIMARY KEY, AUTO_INCREMENT)
- name (VARCHAR 255)
- sku (VARCHAR 100, UNIQUE)
- price (DECIMAL 10,2)
- stock (INT)
- created_at (DATETIME)
- updated_at (DATETIME)

### import_jobs table
- id (INT, PRIMARY KEY, AUTO_INCREMENT)
- filename (VARCHAR 255)
- status (ENUM: pending, in_progress, completed, failed)
- total (INT)
- success (INT)
- failed (INT)
- error_message (TEXT, nullable)
- created_at (DATETIME)
- updated_at (DATETIME)

### users table
- Standard Laravel users table with JWT authentication support

## Troubleshooting

### Redis Connection Failed
```bash
# Check Redis status
redis-cli ping

# Start Redis
redis-server
```

### Queue Not Processing
```bash
# Clear failed jobs
php artisan queue:flush

# Restart queue worker
php artisan queue:restart
```

### Permission Issues
```bash
chmod -R 775 storage bootstrap/cache storage/app/imports
chown -R www-data:www-data storage bootstrap/cache
```